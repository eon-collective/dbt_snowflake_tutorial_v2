name: CI pipe check for dbt projects
on:
  push:
    branches: [ "feature/*" ]
  pull_request:
    branches: [ "main" ]

env:
  DBT_PROJECT_NAME: jaffle_shop
  DBT_DW_ACCOUNT_URL: ${{ secrets.DBT_DW_ACCOUNT_URL }}
  DBT_DW_USER: ${{ secrets.DBT_DW_USER }}
  DBT_DW_PASSWORD: ${{ secrets.DBT_DW_PASSWORD }}
  DBT_DW_ROLE: ${{ secrets.DBT_DW_ROLE }}
  DBT_DW_DB: ${{ secrets.DBT_DW_DB }}
  DBT_DW_SCHEMA: ${{ secrets.DBT_DW_SCHEMA }}
  DBT_DW_VIRT_WH: ${{ secrets.DBT_DW_VIRT_WH }}
  DBT_NUM_THREADS: 20
  DBT_QUERY_TAG: dbt_ci_pipe
  
jobs:
    compile:
        name: Build and Compile dbt Project on dbt cloud
        runs-on: ubuntu-latest
        steps:
          - name: Check out the repo hosting the dbt project
            uses: actions/checkout@main
          - name: set up dbt connection details
            id: my_string
            run: |
                MY_STRING=$(cat << EOF
                ${{ env.DBT_PROJECT_NAME }}:
                  target: dev
                  outputs:
                    dev:
                      type: snowflake
                      account: ${{ env.DBT_DW_ACCOUNT_URL }} 
                      client_session_keep_alive: true
                      database: ${{ env.DBT_DW_DB }}
                      password: ${{ env.DBT_DW_PASSWORD }}
                      query_tag: ${{ env.DBT_QUERY_TAG }}
                      role: ${{ env.DBT_DW_ROLE }}
                      schema: ${{ env.DBT_DW_SCHEMA }}
                      threads: ${{ env.DBT_NUM_THREADS }}
                      user: ${{ env.DBT_DW_USER }}
                      warehouse: ${{ secrets.DBT_DW_VIRT_WH }}
                EOF
                )
                MY_STRING="${MY_STRING//'%'/'%25'}"
                MY_STRING="${MY_STRING//$'\n'/'%0A'}"
                MY_STRING="${MY_STRING//$'\r'/'%0D'}"
                echo "content={$MY_STRING}" >> $GITHUB_OUTPUT
          - name: Get and Use dbt docker image to access dbt project
            uses: addnab/docker-run-action@v3
            with:
                image: ghcr.io/dbt-labs/dbt-snowflake:latest
                options: -v ${{ github.workspace }}:/work -e ABC=123
                shell: bash
                run: |
                  echo "The profile string is: ${{ steps.my_string.outputs.content }}"
                  mkdir ~/.dbt
                  touch /root/.dbt/profiles.yml
                  echo -e "${{ steps.my_string.outputs.content }}" >> /root/.dbt/profiles.yml
                  cd /work
                  dbt deps
                  dbt debug
                  dbt compile
                  dbt run
                  dbt test
                  dbt clean
