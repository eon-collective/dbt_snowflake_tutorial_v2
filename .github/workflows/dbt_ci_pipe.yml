name: CI pipe check for dbt projects
on:
  push:
    branches: [ "feature/*" ]
  pull_request:
    branches: [ "main" ]

# env:
#   DBT_PROJECT_NAME: jaffle_shop
#   DBT_DW_ACCOUNT_URL: ${{ secrets.DBT_DW_ACCOUNT_URL }}
#   DBT_DW_USER: ${{ secrets.DBT_DW_USER }}
#   DBT_DW_PASSWORD: ${{ secrets.DBT_DW_PASSWORD }}
#   DBT_DW_ROLE: ${{ secrets.DBT_DW_ROLE }}
#   DBT_DW_DB: ${{ secrets.DBT_DW_DB }}
#   DBT_DW_SCHEMA: ${{ secrets.DBT_DW_SCHEMA }}
#   DBT_DW_VIRT_WH: ${{ secrets.DBT_DW_VIRT_WH }}
#   DBT_NUM_THREADS: 20
#   DBT_QUERY_TAG: dbt_ci_pipe
  
jobs:
    compile:
        name: Build and Compile dbt Project on dbt cloud
        runs-on: ubuntu-latest
        steps:
          - name: Check out the repo hosting the dbt project
            uses: actions/checkout@main
          - name: set up dbt connection details
            env:
              DBT_PROJECT_NAME: jaffle_shop
              DBT_DW_ACCOUNT_URL: ${{ secrets.DBT_DW_ACCOUNT_URL }}
              DBT_DW_USER: ${{ secrets.DBT_DW_USER }}
              DBT_DW_PASSWORD: ${{ secrets.DBT_DW_PASSWORD }}
              DBT_DW_ROLE: ${{ secrets.DBT_DW_ROLE }}
              DBT_DW_DB: ${{ secrets.DBT_DW_DB }}
              DBT_DW_SCHEMA: ${{ secrets.DBT_DW_SCHEMA }}
              DBT_DW_VIRT_WH: ${{ secrets.DBT_DW_VIRT_WH }}
              DBT_NUM_THREADS: 20
              DBT_QUERY_TAG: dbt_ci_pipe
            run: |
              mkdir ~/.dbt
              touch /root/.dbt/profiles.yml
              echo DBT_PROJECT_NAME >> /root/.dbt/profiles.yml
              echo DBT_DW_ACCOUNT_URL >> /root/.dbt/profiles.yml
              echo DBT_DW_USER >> /root/.dbt/profiles.yml
              echo DBT_DW_PASSWORD >> /root/.dbt/profiles.yml
              echo DBT_DW_ROLE >> /root/.dbt/profiles.yml
              echo DBT_DW_SCHEMA >> /root/.dbt/profiles.yml
              echo DBT_DW_DB >> /root/.dbt/profiles.yml
              echo DBT_DW_VIRT_WH >> /root/.dbt/profiles.yml
              echo DBT_NUM_THREADS >> /root/.dbt/profiles.yml
              echo DBT_QUERY_TAG >> /root/.dbt/profiles.yml
          - name: Get and Use dbt docker image to access dbt project
            uses: addnab/docker-run-action@v3
            with:
                image: ghcr.io/dbt-labs/dbt-snowflake:latest
                options: -v ${{ github.workspace }}:/work -e ABC=123
                shell: bash
                run: |
                  cd /work
                  dbt deps
                  dbt debug
                  dbt compile
                  dbt run
                  dbt test
                  dbt clean
